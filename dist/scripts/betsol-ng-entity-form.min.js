/**
 * betsol-ng-entity-form - Automatic entity forms for Angular.js
 * @version v0.0.0
 * @link https://github.com/betsol/ng-entity-form
 * @license MIT
 *
 * @author Slava Fomin II <s.fomin@betsol.ru>
 */
!function(e,t){"use strict";function n(e,t){var n={};return o(e,function(e){n[e]=t[e]||null}),n}function r(e,t){var n={};return o(e,function(e,r){t[e]&&!r.readonly&&(n[e]=t[e])}),n}function i(e){return t.forEach(e,function(n,r){e[r]=t.extend({},s,n),t.forEach(e[r].fields,function(n,i){e[r].fields[i]=t.extend({},u,n)})}),o(e,function(e,t){switch(t.type){case"string":case"url":t.elementType="input"}switch(t.type){case"string":t.inputType="text";break;default:t.inputType=t.type}}),e}function o(e,n){t.forEach(e,function(r,i){t.forEach(e[i].fields,function(e,t){n(t,e)})})}function c(t){return function(n,r){function i(){"success"==t&&alert("Данные успешно сохранены")}if(r.has("previousUrl")){var o=r.get("previousUrl");if(o.hasUrl())return o.redirectBack(),void 0}if(r.has("$state")){var c=r.get("$state");return n.redirectState?c.go(n.redirectState):(i(),c.reload()),void 0}if(r.has("router")){var s=r.get("router");return i(),s.reload(),void 0}i(),e.location.reload()}}var s={title:"",fields:{}},u={title:"",type:"string",readonly:!1,required:!1};t.module("betsol.entityForm",[]).factory("EntityForm",["$rootScope","$injector",function(e,t){var o=new c("success"),s=new c("cancel");return function(e){if(!e.scope)return console.log("Missing scope");if(!e.repository)return console.log("Missing repository");var c=e.scope,u=e.entity||{},a=e.mode||"create",f=e.repository,l=i(e.scheme||{});return"function"==typeof e.successStrategy&&(o=e.successStrategy),"function"==typeof e.cancelStrategy&&(s=e.cancelStrategy),"update"!=a||u.id?(c.processing=!1,c.mode=a,c.entity=n(l,u),c.formScheme=l,c.save=function(n){if(!c.processing){if(!n.$valid)return alert("Пожалуйста, заполните форму корректно");c.processing=!0;var i=r(l,c.entity);"update"==a&&(i.id=u.id),f.save(i).then(function(){t.invoke(o,null,{config:e,$scope:c})}).catch(function(){alert("Не удалось сохранить форму, пожалуйста, проверьте вводимые данные")}).finally(function(){c.processing=!1})}},c.reset=function(){c.entity=n(l,u)},c.cancel=function(){t.invoke(s,null,{config:e,$scope:c})},void 0):console.log("Entity must have an ID in update mode")}}])}(window,angular);