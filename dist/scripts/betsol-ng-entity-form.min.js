/**
 * betsol-ng-entity-form - Automatic entity forms for Angular.js
 * @version v0.0.4
 * @link https://github.com/betsol/ng-entity-form
 * @license MIT
 *
 * @author Slava Fomin II <s.fomin@betsol.ru>
 */
!function(window,angular){"use strict";function scopeEntityFromEntity(e){return angular.extend({},e)}function getDataToSave(e,t){var n={};return iterateFields(e,function(e,r){getPropertyValue(r.readonly,t)||r.hidden||propertyPathSet(n,e,propertyPathGet(t,e))}),n}function normalizeForm(e){return angular.forEach(e,function(t,n){e[n]=angular.extend({},defaultFieldset,t),angular.forEach(e[n].fields,function(t,r){e[n].fields[r]=angular.extend({},defaultField,t)})}),iterateFields(e,function(e,t){switch(t.type){case"string":case"url":case"boolean":case"email":case"phoneNumber":case"number":t.elementType="input";break;case"datetime":case"date":t.elementType=t.type;break;case"enum":t.selectExpression||(t.selectExpression="key as value for (key, value)");break;case"text":t.rowsCount||(t.rowsCount=10)}switch(t.type){case"string":t.inputType="text";break;case"boolean":t.inputType="checkbox";break;case"phoneNumber":t.inputType="tel";break;default:t.inputType=t.type}}),e}function iterateFields(e,t){angular.forEach(e,function(n,r){angular.forEach(e[r].fields,function(e,n){t(n,e)})})}function RedirectStrategy(e){var t=function(t,n){function r(){"success"==e&&alert("Данные успешно сохранены")}if(n.has("previousUrl")){var o=n.get("previousUrl");if(o.hasUrl())return void o.redirectBack()}if(n.has("$state")){var a=n.get("$state");return void(t.redirectState?a.go(t.redirectState):(r(),a.reload()))}if(n.has("router")){var i=n.get("router");return r(),void i.reload()}r(),window.location.reload()};return t.$inject=["config","$injector"],t}function propertyPathSet(e,t,n){var r=t.split("."),o=e,a=0,i=r.length-1;angular.forEach(r,function(e){o[e]=o[e]||{},a==i?o[e]=n:o=o[e],a++}),o=n}function propertyPathGet(object,path){return eval("object."+path)}function getPropertyValue(e,t){return"function"==typeof e?e(t):e}var defaultFieldset={title:"",fields:{}},defaultField={title:"",type:"string",readonly:!1,required:!1};angular.module("betsol.entityForm",["ui.bootstrap","ui.bootstrap.datetimepicker"]).factory("EntityForm",["$rootScope","$injector","$parse",function(e,t,n){var r=new RedirectStrategy("success"),o=new RedirectStrategy("cancel");return function(e){var a={scope:null,repository:null,entity:null,mode:null,scheme:null,successStrategy:null,cancelStrategy:null,redirectState:null};if(e=angular.extend({},a,e),!e.scope)return console.log("Missing scope");if(!e.repository)return console.log("Missing repository");var i=e.scope,c=e.entity||{},u=e.mode||"create",s=e.repository,l=normalizeForm(e.scheme||{});return"function"==typeof e.successStrategy&&(r=e.successStrategy),"function"==typeof e.cancelStrategy&&(o=e.cancelStrategy),"update"!=u||c.id?(i.processing=!1,i.mode=u,i.entity=scopeEntityFromEntity(c),i.formScheme=l,i.save=function(n){if(!i.processing){if(!n.$valid)return alert("Пожалуйста, заполните форму корректно");i.processing=!0;var o=getDataToSave(l,i.entity);"update"==u&&(o.id=c.id),s.save(o).then(function(){t.invoke(r,null,{config:e,$scope:i})})["catch"](function(){alert("Не удалось сохранить форму, пожалуйста, проверьте вводимые данные")})["finally"](function(){i.processing=!1})}},i.reset=function(){i.entity=scopeEntityFromEntity(c)},i.cancel=function(){t.invoke(o,null,{config:e,$scope:i})},i.entityPath=function(e){var t=n(e),r=t.assign;return function(e){return"undefined"!=typeof e&&r(i,e),t(i)}},i.getInputAddonImage=function(e,t){return"function"==typeof t?t(e):t},void(i.getReadonly=function(e,t,n){return getPropertyValue(n.readonly,e)})):console.log("Entity must have an ID in update mode")}}]).directive("dateTimeModel",function(){return{restrict:"A",require:"ngModel",link:function(e,t,n,r){r.$formatters.push(function(e){return moment.isMoment(e)?e.toDate():e}),r.$parsers.push(function(e){return e instanceof Date?moment(e):e})}}})}(window,angular);